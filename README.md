# ash-devcontainer

## Step by step for get started with ash

Please see https://hexdocs.pm/ash/get-started.html

### Create a new ash project, then enter into a new one.

```bash
$ yes | mix igniter.new helpdesk --install ash
$ cd helpdesk
```

### Our first domain and resource

```bash
$ mkdir -p lib/helpdesk/support && touch $_/ticket.ex
$ touch lib/helpdesk/support.ex
```

Thrn, look `lib` directory with `tree` command.

```bash
$ tree lib/
lib/
├── helpdesk
│   ├── support
│   │   └── ticket.ex
│   └── support.ex
└── helpdesk.ex
```

### Edit a Support domain

Edit `lib/helpdesk/support.ex` as following.

```elixir
defmodule Helpdesk.Support do
  use Ash.Domain

  resources do
    resource Helpdesk.Support.Ticket
  end
end
```

### Edit a Ticket resource

Then, edit `lib/helpdesk/support/ticket.ex` as following.

```elixir
defmodule Helpdesk.Support.Ticket do
  # This turns this module into a resource
  use Ash.Resource, domain: Helpdesk.Support

  actions do
    # Use the default implementation of the :read action
    defaults [:read]

    # and a create action, which we'll customize later
    create :create
  end

  # Attributes are the simple pieces of data that exist on your resource
  attributes do
    # Add an autogenerated UUID primary key called `:id`.
    uuid_primary_key :id

    # Add a string type attribute called `:subject`
    attribute :subject, :string
  end
end
```

### Edit config file

Edit `config/config.exs` as following.

```elixir
import Config

config :helpdesk, :ash_domains, [Helpdesk.Support]

config :ash,
  include_embedded_source_by_default?: false,
  default_page_type: :keyset

config :ash, :policies,
  no_filter_static_forbidden_reads?: false
```

### Try a ticket recource

```bash
$ iex -S mix
```

```elixir
iex(1)> Helpdesk.Support.Ticket |> Ash.Changeset.for_create(:create) |> Ash.create!()
#Helpdesk.Support.Ticket<
  __meta__: #Ecto.Schema.Metadata<:built, "">,
  id: "b9b4f008-a2d6-4145-bd09-d37f3f9e445a",
  subject: nil,
  aggregates: %{},
  calculations: %{},
  ...
>
```

### Customizing our Actions

We add tiny changes to `:subject` attribute in `Helpdesk.Support.Ticket` resource.

1. `:subject` can not to be `nil`
2. `:subject` can be access as public.

```diff
# lib/helpdesk/support/ticket.ex
19c23,26
<     attribute :subject, :string
---
>     attribute :subject, :string do
>       allow_nil? false
>       public? true
>     end
```

Then, we add a new `:open` action.

```diff
10a11,14
> 
>     create :open do
>       accept [:subject]
>     end
```

And we add another attribute `:status` as `:atom`.

```diff
21a26,31
>     end
> 
>     attribute :status, :atom do
>       constraints [one_of: [:open, :closed]]
>       default :open
>       allow_nil? false
```

### Try a ticket resource again

```bash
$ iex -S mix
```

```elixir
iex(1)> recompile()
:noop
iex(2)> Helpdesk.Support.Ticket |> Ash.Changeset.for_create(:open, %{subject: "I'm ytnobody!"}) |> Ash.create!()
#Helpdesk.Support.Ticket<
  __meta__: #Ecto.Schema.Metadata<:built, "">,
  id: "4d0d6d51-b569-4a67-842a-2fd113df0c37",
  subject: "I'm ytnobody!",
  status: :open,
  aggregates: %{},
  calculations: %{},
  ...
>
```

If we forgot a specify `:subject`, we going to see following error.

```elixir
iex(3)> Helpdesk.Support.Ticket |> Ash.Changeset.for_create(:open) |> Ash.create!()
** (Ash.Error.Invalid) 
Bread Crumbs:
  > Error returned from: Helpdesk.Support.Ticket.open

Invalid Error

* attribute subject is required
  (ash 3.4.46) lib/ash/error/changes/required.ex:4: Ash.Error.Changes.Required.exception/1
  (ash 3.4.46) lib/ash/changeset/changeset.ex:3335: Ash.Changeset.add_required_attribute_error/2
  (elixir 1.16.3) lib/enum.ex:2528: Enum."-reduce/3-lists^foldl/2-0-"/3
  (ash 3.4.46) lib/ash/changeset/changeset.ex:1951: Ash.Changeset.do_for_action/4
  (stdlib 6.1.2) erl_eval.erl:900: :erl_eval.do_apply/7
  (stdlib 6.1.2) erl_eval.erl:1192: :erl_eval.expr_list/7
  (stdlib 6.1.2) erl_eval.erl:610: :erl_eval.expr/6
    (ash 3.4.46) lib/ash/error/invalid.ex:3: Ash.Error.Invalid.exception/1
    (ash 3.4.46) /workspaces/ash-devcontainer/helpdesk/deps/splode/lib/splode.ex:264: Ash.Error.to_class/2
    (ash 3.4.46) lib/ash/error/error.ex:108: Ash.Error.to_error_class/2
    (ash 3.4.46) lib/ash/actions/create/create.ex:155: Ash.Actions.Create.do_run/4
    (ash 3.4.46) lib/ash/actions/create/create.ex:50: Ash.Actions.Create.run/4
    (ash 3.4.46) lib/ash.ex:2134: Ash.create!/3
```

